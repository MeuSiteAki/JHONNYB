<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JHONNYBAGD√Å | Sistema Integrado</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap');

    :root {
      --bg-black: #0a0a0a;
      --card-gray: #161616;
      --accent: #ffb800;
      --text-white: #f0f0f0;
      --text-dim: #a0a0a0;
      --danger: #ff4d4d;
      --success: #00e600;
      --border: #262626;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Outfit', sans-serif; background-color: var(--bg-black); color: var(--text-white); padding: 20px; }

    header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 25px; gap: 15px; flex-wrap: wrap; }
    h1 { font-weight: 700; font-size: 24px; }
    h1 span { color: var(--accent); }

    .tabs { display: flex; gap: 10px; }
    .tab-btn { padding: 12px 24px; background: var(--card-gray); border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; border-radius: 8px; font-weight: 600; transition: 0.2s; }
    .tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

    .content-section { display: none; }
    .content-section.active { display: block; }

    /* Grid e Cards Estilo Original */
    .lista { display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); }
    .grid-mesas { display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }

    .pedido, .mesa-card { background: var(--card-gray); border: 1px solid var(--border); border-radius: 16px; padding: 20px; transition: 0.2s; }
    .pedido.origem-mesa { border-left: 5px solid var(--success); }
    .mesa-card { text-align: center; cursor: pointer; border: 2px solid var(--border); }
    .mesa-card.ocupada { border-color: var(--danger); background: #1a0a0a; }
    .mesa-card.disponivel { border-color: var(--success); }

    /* Accordion Menu */
    .cat-container { margin-bottom: 10px; border-radius: 10px; overflow: hidden; border: 1px solid #333; }
    .cat-header { background: #222; padding: 15px; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; color: var(--accent); }
    .cat-content { display: none; background: #111; padding: 10px; grid-template-columns: 1fr 1fr; gap: 10px; }
    .cat-content.open { display: grid; }

    .item-btn { background: #1a1a1a; padding: 12px; border-radius: 8px; cursor: pointer; border: 1px solid #333; display: flex; flex-direction: column; font-size: 13px; }
    .item-btn:hover { border-color: var(--accent); }
    .item-btn b { color: var(--accent); margin-top: 4px; }

    /* Modal */
    .modal { position: fixed; top:0; left:0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--card-gray); width: 95%; max-width: 1000px; height: 90vh; border-radius: 20px; padding: 25px; display: flex; flex-direction: column; }
    .modal-body { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; overflow: hidden; flex-grow: 1; }
    .scroll-area { overflow-y: auto; padding-right: 10px; }

    /* Bot√µes de A√ß√£o Original */
    .btn-fechar { background: var(--success); color: #000; padding: 15px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; width: 100%; margin-top: 10px; font-size: 16px; }
    .btn-del { background: #331a1a; color: var(--danger); padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 11px; font-weight: 600; }
    
    .itens-lista { margin: 15px 0; padding: 12px; background: #000000; border-radius: 10px; font-size: 14px; min-height: 100px; }
    .item-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #222; }
    /* Ajuste para que o texto do select do SweetAlert fique vis√≠vel */
.swal2-select {
  color: #000 !important; /* Texto preto */
  background-color: #fff !important; /* Fundo branco para contraste */
  font-family: 'Outfit', sans-serif;
  border-radius: 8px;
}

/* Ajuste para as op√ß√µes dentro do select */
.swal2-select option {
  color: #000 !important;
  background-color: #fff !important;
}
/* Layout padr√£o (desktop) */
.modal-body {
  display: grid;
  grid-template-columns: 1.2fr 0.8fr;
  gap: 20px;
  overflow: hidden;
  flex-grow: 1;
}

/* Layout adaptado para celular */
@media (max-width: 768px) {
  .modal-body {
    grid-template-columns: 1fr; /* apenas uma coluna */
    grid-template-rows: auto auto; /* card√°pio em cima, resumo embaixo */
  }

  /* opcional: aumentar o espa√ßo interno no celular */
  .modal-content {
    width: 100%;
    height: 100vh;
    border-radius: 0; /* ocupa toda a tela */
    padding: 15px;
  }
}
/* Em telas grandes (desktop), for√ßa 3 colunas */
@media (min-width: 1024px) {
  .lista {
    grid-template-columns: repeat(3, 1fr);
  }
}

  </style>
</head>
<body>

 <header>
  <h1>JHONNY<span>BAGD√Å</span></h1>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('delivery')">DELIVERY</button>
    <button class="tab-btn" onclick="switchTab('salao')">SAL√ÉO/MESAS</button>
  </div>
  
  <button onclick="toggleAdminMenu()" class="tab-btn" style="background:#222; border-color: var(--accent);">‚öôÔ∏è</button>

  <div id="adminMenu" style="display:none; position: absolute; top: 70px; right: 20px; background: var(--card-gray); border: 1px solid var(--accent); border-radius: 12px; padding: 15px; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); flex-direction: column; gap: 10px;">
    <button id="ativarSom" class="tab-btn" style="background:var(--accent); color:#000; width: 100%;">üîî ATIVAR SISTEMA</button>
    <button class="tab-btn" onclick="switchTab('balanco'); toggleAdminMenu();" style="width: 100%;">üìä VER BALAN√áO</button>
    <button class="btn-del" onclick="apagarTodosPedidos(); toggleAdminMenu();" style="padding: 12px; font-size: 14px;">üóëÔ∏è APAGAR TUDO</button>
  </div>
</header>

  <main id="delivery-section" class="content-section active">
    <h2>üîî Pedidos Novos</h2>
    <div id="lista-pedidos" class="lista"></div>
    <h2 style="margin-top:40px; color: var(--text-dim)">üìÇ Hist√≥rico Recente</h2>
    <div id="lista-antigos" class="lista"></div>
  </main>

  <main id="salao-section" class="content-section">
    <h2>üçΩÔ∏è Mapa de Mesas em Tempo Real</h2>
    <div id="grid-mesas" class="grid-mesas"></div>
  </main>
<main id="balanco-section" class="content-section">
  <h2>üìä Balan√ßo Geral</h2>
  <div id="balancoValores" style="margin-top:20px; font-size:18px"></div>
</main>

  <div id="modalMesa" class="modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
        <h2 id="modalTitulo" style="color:var(--accent)">Mesa 00</h2>
        <button onclick="fecharModal()" class="tab-btn">VOLTAR</button>
      </div>
      <div class="modal-body">
        <div class="scroll-area" id="cardapioRender"></div>
        <div style="display:flex; flex-direction:column; background:#0b0b0b; padding:20px; border-radius:15px; border: 1px solid #222;">
          <h3 style="margin-bottom:10px">Resumo da Conta</h3>
          <div id="consumoMesa" class="itens-lista" style="flex-grow:1; overflow-y:auto"></div>
          <h2 id="totalMesa" style="color:var(--accent); font-size: 36px; margin-bottom:15px">R$ 0,00</h2>
          <button class="btn-fechar" onclick="enviarFechamentoMesa()">FECHAR CONTA E IMPRIMIR</button>
        </div>
      </div>
    </div>
  </div>

  <audio id="bip" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
  </audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, orderBy, query, deleteDoc, doc, addDoc, setDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBHBcJHtU_o8tjsJCSoCsO665M3N72mF8g",
      authDomain: "meusiteaki2025.firebaseapp.com",
      projectId: "meusiteaki2025",
      storageBucket: "meusiteaki2025.firebasestorage.app",
      messagingSenderId: "1059720978927",
      appId: "1:1059720978927:web:c4e5fde24aa95672d0161a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const cardapio = {
      "Lanches": [
        { nome:"Misto", preco:6 }, { nome:"Americano", preco:10 }, { nome:"X-Salsicha", preco:12 },
        { nome:"Bauru Simples", preco:12 }, { nome:"Bauru Especial", preco:14 }, { nome:"Hamb√∫rguer", preco:14 },
        { nome:"X-Catupiry", preco:14 }, { nome:"X-Salada Simples", preco:14 }, { nome:"X-Abacaxi", preco:16 },
        { nome:"X-Salada Especial", preco:15 }, { nome:"X-Banana", preco:16 }, { nome:"X-Calabresa Simples", preco:15 },
        { nome:"X-Calabresa Especial", preco:17 }, { nome:"X-Bacon", preco:17 }, { nome:"X-Frango Simples", preco:15 },
        { nome:"X-Frango Especial", preco:17 }, { nome:"X-Tudo", preco:18 }, { nome:"X-Fil√©", preco:25 },
        { nome:"X-Jhone Broca", preco:22 }, { nome:"X-Completa√ß√£o", preco:26 }, { nome:"X-Arrisca", preco:28 }
      ],
      "Bebidas": [
        { nome:"Refrigerante 250ml", preco:4, marcas:["Coca-Cola","Guaran√° Ant√°rtica","Fanta","River"] },
        { nome:"Refrigerante Lata 350ml", preco:6, marcas:["Coca-Cola","Guaran√° Ant√°rtica","Fanta","Sprite","Gua.Jesus"] },
        { nome:"Refrigerante 600ml", preco:7, marcas:["Coca-Cola","Guaran√° Ant√°rtica","Fanta","River"] },
        { nome:"Refrigerante 1L", preco:10, marcas:["Coca-Cola","Guaran√° Ant√°rtica","Fanta","River"] },
        { nome:"Refrigerante 1,5L", preco:11, marcas:["Coca-Cola","Fanta"] },
        { nome:"Refrigerante 2L", preco:13, marcas:["Coca-Cola","Guaran√° Ant√°rtica","Fanta","River","Coca Zero","Fanta Uva"] },
        { nome:"Suco de Acerola", preco:6 }, { nome:"Suco de Maracuj√°", preco:6 }, { nome:"Suco de Cupua√ßu", preco:7 },
        { nome:"Suco de Laranja 450ml", preco:8 }, { nome:"Vitamina de Cupua√ßu", preco:7 }
      ],
      "Por√ß√µes": [ { nome:"Por√ß√£o de batata frita", preco:17 } ],
      "Adicionais": [
        { nome:"Bacon", preco:3 }, { nome:"Calabresa", preco:2 }, { nome:"Cheddar", preco:2 },
        { nome:"Carne Hamb√∫rguer", preco:5 }, { nome:"Fil√© de Frango", preco:5 }, { nome:"Fil√©", preco:7 },
        { nome:"Presunto", preco:2 }, { nome:"Queijo", preco:2 }, { nome:"Ovo", preco:2 }, { nome:"Salsicha", preco:1 },
        { nome:"Banana", preco:3 }, { nome:"Catupiry", preco:2 }, { nome:"Maionese Temperada", preco:1 }
      ]
    };

    let mesaAtiva = null;
    let mesasConsumo = {};
    let somAtivado = false;
    const audioBip = document.getElementById('bip');

    // ATIVA√á√ÉO
    document.getElementById('ativarSom').onclick = function() { somAtivado = true; this.style.display = 'none'; };

    window.switchTab = (tab) => {
      document.querySelectorAll('.tab-btn, .content-section').forEach(el => el.classList.remove('active'));
      document.getElementById(tab + '-section').classList.add('active');
      event.currentTarget.classList.add('active');
    };

    // SYNC MAPA MESAS
    onSnapshot(collection(db, "mapa_mesas"), (snap) => {
      mesasConsumo = {};
      snap.forEach(d => { mesasConsumo[d.id] = d.data().itens || []; });
      renderMapaMesas();
      if(mesaAtiva) atualizarConsumo();
    });

   // SYNC DELIVERY & BIPS
// --- 1. SYNC DELIVERY & BIPS (SUBSTITUA DESDE O ONSNAPSHOT AT√â O FINAL DELE) ---
onSnapshot(query(collection(db, "pedidos"), orderBy("timestamp", "desc")), (snap) => {
    const listaP = document.getElementById('lista-pedidos');
    const listaA = document.getElementById('lista-antigos');
    
    if (!listaP || !listaA) return; 

    listaP.innerHTML = ""; 
    listaA.innerHTML = "";

    if (somAtivado && !snap.metadata.fromCache && snap.docChanges().some(c => c.type === "added")) {
        if (audioBip) audioBip.play().catch(() => {});
    }

  // --- DENTRO DO SEU ONSNAPSHOT DE PEDIDOS ---
snap.docs.forEach((d, i) => {
    const p = d.data();
    const id = d.id;
    const eMesa = p.cliente && p.cliente.includes("MESA");
    const container = (i === 0) ? listaP : listaA;
    const div = document.createElement('div');
    div.className = `pedido ${eMesa ? 'origem-mesa' : ''}`;

    // Limpeza do n√∫mero de telefone (remove espa√ßos e caracteres especiais)
    const telLimpo = p.telefone ? p.telefone.replace(/\D/g, '') : '';
    
    // Mensagens pr√©-definidas
    const msgRecebido = encodeURIComponent("Ol√°, recebemos seu pedido, por favor aguarde...");
    const msgEntrega = encodeURIComponent("Seu pedido saiu para entrega, JhonnyBagd√° agradece!");

    const itensHtml = (p.itens || []).map(it =>
        `${it.quantity || 1}x ${it.name} ‚Äî R$ ${Number(it.price || 0).toFixed(2).replace('.', ',')}`
    ).join('<br>');

    const taxaEntrega = p.taxaEntrega ? `üöö Entrega: R$ ${Number(p.taxaEntrega).toFixed(2).replace('.', ',')}<br>` : '';
    const obs = p.observacao ? `üìù Obs: ${p.observacao}` : '';

    div.innerHTML = `
        <div style="margin-bottom:10px">
            <b>üë§ Cliente:</b> ${p.cliente}<br>
            ${p.telefone ? `üìû Tel: ${p.telefone}<br>` : ''}
            ${p.endereco ? `üè† Endere√ßo: ${p.endereco}<br>` : ''}
            ${p.pagamento ? `üí≥ Pagamento: ${p.pagamento}<br>` : ''}
        </div>
        <div style="margin-bottom:10px">
            üçî <b>Itens:</b><br>${itensHtml}<br>
            <br>${taxaEntrega}
            üí∞ <b>Total:</b> ${p.total}
            <br>${obs}
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
            <a href="https://wa.me/55${telLimpo}?text=${msgRecebido}" target="_blank" 
               style="background:#001483; color:white; text-decoration:none; padding:10px; border-radius:8px; font-size:11px; font-weight:bold; text-align:center;">
               ‚úÖ PEDIDO RECEBIDO
            </a>
            <a href="https://wa.me/55${telLimpo}?text=${msgEntrega}" target="_blank" 
               style="background:#006100; color:white; text-decoration:none; padding:10px; border-radius:8px; font-size:11px; font-weight:bold; text-align:center;">
               üõµ SAIU P/ ENTREGA
            </a>
        </div>

        <div style="margin-top: 8px;">
            ${p.endereco ? `<button class="tab-btn rota-btn" style="background:#4285F4; color:#fff; width:100%; padding:10px;" data-endereco="${p.endereco}">üìç Ver rota no Mapa</button>` : ''}
        </div>
    `;

    container.appendChild(div);
});

    // 2. ADICIONAR EVENTOS (Corrigido para usar a fun√ß√£o atualizada)
    document.querySelectorAll(".rota-btn").forEach(btn => {
        btn.onclick = () => {
            let endereco = btn.getAttribute("data-endereco").trim();
            mostrarRota(endereco);
        };
    });
});

// --- 2. FUN√á√ÉO MOSTRAR ROTA (Mantenha esta fora do onSnapshot) ---
function mostrarRota(enderecoCliente) {
    if (!enderecoCliente) return;

    const API_KEY = "AIzaSyBHf-79l4rVWBx9S4HHhod-qfvatPrTsGA";
    const origem = "1036 R. Jos√© dos R√©is Feitosa, Itinga do Maranh√£o, Maranh√£o";
    
    // --- L√ìGICA DE LIMPEZA (O SANITIZADOR) ---
    let enderecoFormatado = enderecoCliente.trim();

    // 1. Se n√£o tiver v√≠rgula, tenta colocar uma antes do primeiro n√∫mero encontrado
    if (!enderecoFormatado.includes(',')) {
        enderecoFormatado = enderecoFormatado.replace(/(\s)(\d+)/, ', $2');
    }

    // 2. Garante que Itinga e o CEP estejam no final para travar o GPS na regi√£o
    if (!/itinga/i.test(enderecoFormatado)) {
        enderecoFormatado += ", Itinga do Maranh√£o, MA, 65939-000, Brasil";
    }

    // --- FIM DA LIMPEZA ---

    // Usamos o modo VIEW com ZOOM m√°ximo para maior detalhamento
    const iframeUrl = `https://www.google.com/maps/embed/v1/place?key=${API_KEY}&q=${encodeURIComponent(enderecoFormatado)}&zoom=19`;

    Swal.fire({
        title: 'Localiza√ß√£o da Entrega',
        html: `
            <div style="border-radius:12px; overflow:hidden; background: #222; border: 2px solid var(--accent);">
                <iframe width="100%" height="400" style="border:0" src="${iframeUrl}" allowfullscreen></iframe>
            </div>
            <div style="background:#222; padding:10px; margin-top:10px; border-radius:8px; text-align:left;">
                <small style="color:#00e676; font-weight:bold;">üìç Endere√ßo Processado:</small><br>
                <span style="color:#fff; font-size:13px;">${enderecoFormatado}</span>
            </div>
            <div style="margin-top:15px;">
                <a href="https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origem)}&destination=${encodeURIComponent(enderecoFormatado)}&travelmode=driving" 
                   target="_blank" 
                   style="display:block; padding:18px; background:#4285F4; color:white; text-decoration:none; border-radius:10px; font-weight:bold; text-align:center; font-size:18px;">
                   üöó INICIAR NAVEGA√á√ÉO NO GPS
                </a>
            </div>`,
        width: 800,
        background: '#161616',
        color: '#fff',
        showConfirmButton: false,
        showCloseButton: true
    });
}

    function renderMapaMesas() {
      const grid = document.getElementById('grid-mesas');
      grid.innerHTML = "";
      for(let i=1; i<=6; i++) {
        const itens = mesasConsumo[i] || [];
        const ocupada = itens.length > 0;
        const total = itens.reduce((acc, it) => acc + (Number(it.preco) || 0), 0);
        const div = document.createElement('div');
        div.className = `mesa-card ${ocupada ? 'ocupada' : 'disponivel'}`;
        div.onclick = () => abrirMesa(i);
        div.innerHTML = `<h3>${i.toString().padStart(2, '0')}</h3><p>${ocupada ? 'R$ '+total.toFixed(2).replace('.',',') : 'LIVRE'}</p>`;
        grid.appendChild(div);
      }
    }

    window.abrirMesa = (num) => {
      mesaAtiva = num;
      document.getElementById('modalTitulo').innerText = `Atendimento Mesa ${num}`;
      document.getElementById('modalMesa').style.display = 'flex';
      renderAccordion();
      atualizarConsumo();
    };

    function renderAccordion() {
      const container = document.getElementById('cardapioRender');
      container.innerHTML = "";
      for(let cat in cardapio) {
        const div = document.createElement('div');
        div.className = 'cat-container';
        div.innerHTML = `<div class="cat-header" onclick="toggleCat(this)">${cat.toUpperCase()} <span>+</span></div>`;
        const content = document.createElement('div');
        content.className = 'cat-content';
        cardapio[cat].forEach(it => {
          const btn = document.createElement('div');
          btn.className = 'item-btn';
          btn.onclick = () => processarItem(it);
          btn.innerHTML = `<span>${it.nome}</span><b>R$ ${it.preco.toFixed(2)}</b>`;
          content.appendChild(btn);
        });
        div.appendChild(content);
        container.appendChild(div);
      }
    }

    window.toggleCat = (el) => {
      const content = el.nextElementSibling;
      const isOpen = content.classList.contains('open');
      document.querySelectorAll('.cat-content').forEach(c => c.classList.remove('open'));
      if(!isOpen) content.classList.add('open');
    };

   async function processarItem(item) {
  let nomeFinal = item.nome;
  let precoFinal = item.preco;
  let extras = [];

  // 1. Escolher Marca (se for bebida)
  if(item.marcas) {
    const { value: marca } = await Swal.fire({
      title: 'Qual marca?',
      input: 'select',
      inputOptions: item.marcas.reduce((obj, m) => { obj[m] = m; return obj; }, {}),
      background: '#161616', color: '#fff', confirmButtonColor: '#ffb800'
    });
    if(!marca) return;
    nomeFinal += ` (${marca})`;
  }

  // 2. ADICIONAIS (Carnes, Complementos, Vegetais, etc.)
  // Definimos a lista completa conforme sua solicita√ß√£o
  const listaAdicionais = {
    "Carnes": [ {n:"Carne Hamb√∫rguer", p:5}, {n:"Fil√© de Frango", p:5}, {n:"Fil√©", p:7} ],
    "Complementos": [ {n:"Presunto", p:2}, {n:"Queijo", p:2}, {n:"Calabresa", p:2}, {n:"Ovo", p:2}, {n:"Bacon", p:3}, {n:"Salsicha", p:1} ],
    "Vegetais": [ {n:"Alface", p:1}, {n:"Tomate", p:1}, {n:"Cebola", p:2} ],
    "Outros": [ {n:"Banana", p:3}, {n:"Cheddar", p:2}, {n:"Catupiry", p:2} ],
    "Molhos": [ {n:"Mostarda", p:1}, {n:"Barbecue", p:1}, {n:"Maionese Temperada", p:1} ]
  };

  // Criando as op√ß√µes para o Select do SweetAlert
  let opcoesAdicionais = { "nenhum": "Sem adicionais" };
  for (let cat in listaAdicionais) {
    listaAdicionais[cat].forEach(ad => {
      opcoesAdicionais[ad.n] = `${ad.n} (+R$ ${ad.p.toFixed(2)})`;
    });
  }

  const { value: addSelecionado } = await Swal.fire({
    title: 'Adicionar Extra?',
    input: 'select',
    inputOptions: opcoesAdicionais,
    background: '#161616', color: '#fff', confirmButtonColor: '#ffb800',
    showCancelButton: true,
    cancelButtonText: 'Pr√≥ximo'
  });

  if (addSelecionado && addSelecionado !== "nenhum") {
    // Encontrar o pre√ßo do adicional selecionado
    let objAd;
    for (let cat in listaAdicionais) {
      const busca = listaAdicionais[cat].find(a => a.n === addSelecionado);
      if (busca) objAd = busca;
    }
    
    if (objAd) {
      precoFinal += objAd.p;
      extras.push(objAd.n);
    }
  }

  // 3. OBSERVA√á√ÉO (Sem cebola, bem passado, etc.)
  const { value: obs } = await Swal.fire({
    title: 'Observa√ß√£o do Item',
    input: 'text',
    inputPlaceholder: 'Ex: Sem cebola, caprichar no molho...',
    background: '#161616', color: '#fff', confirmButtonColor: '#ffb800',
    showCancelButton: true,
    cancelButtonText: 'Pular'
  });

  // Montagem do texto final
  const descExtras = extras.length > 0 ? ` + ${extras.join(', ')}` : "";

  // 4. SALVAR NO FIREBASE
  const novos = [...(mesasConsumo[mesaAtiva] || []), { 
    nome: nomeFinal + descExtras, 
    preco: precoFinal,
    obs: obs || "" 
  }];
  
  await setDoc(doc(db, "mapa_mesas", mesaAtiva.toString()), { itens: novos });
}
// remover
    window.removerItemMesa = async (idx) => {
      const novos = [...mesasConsumo[mesaAtiva]];
      novos.splice(idx, 1);
      if(novos.length > 0) await setDoc(doc(db, "mapa_mesas", mesaAtiva.toString()), { itens: novos });
      else await deleteDoc(doc(db, "mapa_mesas", mesaAtiva.toString()));
    };

    function atualizarConsumo() {
  const itens = mesasConsumo[mesaAtiva] || [];
  const total = itens.reduce((acc, it) => acc + (Number(it.preco) || 0), 0);
  
  document.getElementById('consumoMesa').innerHTML = itens.map((it, idx) => `
    <div class="item-row" style="flex-direction: column; align-items: flex-start; padding: 10px 0;">
      <div style="display: flex; justify-content: space-between; width: 100%;">
        <b style="color:var(--accent)">${it.nome}</b>
        <span>R$ ${it.preco.toFixed(2)} <button onclick="removerItemMesa(${idx})" style="background:none; border:none; color:red; cursor:pointer; margin-left:8px">‚úï</button></span>
      </div>
      ${it.obs ? `<small style="color: #00e676; margin-top: 4px;">üìù Obs: ${it.obs}</small>` : ''}
    </div>
  `).join('');
  
  document.getElementById('totalMesa').innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
}

   window.enviarFechamentoMesa = async () => {
  const itens = mesasConsumo[mesaAtiva];
  if(!itens || itens.length === 0) return;

  const { value: forma } = await Swal.fire({
    title: 'Forma de pagamento?',
    input: 'select',
    inputOptions: { PIX: 'PIX', Cartao: 'Cart√£o', Dinheiro: 'Dinheiro' },
    background: '#161616', color: '#fff', confirmButtonColor: '#ffb800'
  });

  if(!forma) return;

  const total = itens.reduce((acc, it) => acc + (Number(it.preco) || 0), 0);
  await addDoc(collection(db, "pedidos"), {
    cliente: `MESA ${mesaAtiva.toString().padStart(2, '0')}`,
    total: "R$ " + total.toFixed(2).replace('.', ','),
    pagamento: forma, // <-- novo campo
    timestamp: serverTimestamp(),
    itens: itens.map(i => ({ name: i.nome, price: i.preco, quantity: 1 }))
  });

  await deleteDoc(doc(db, "mapa_mesas", mesaAtiva.toString()));
  fecharModal();
  Swal.fire({ title: 'Enviado!', icon: 'success', background: '#161616', color: '#fff', timer: 1500, showConfirmButton: false });
};
onSnapshot(collection(db, "pedidos"), (snap) => {
  let totalPix = 0, totalCartao = 0, totalDinheiro = 0;

  snap.docs.forEach(d => {
    const p = d.data();
    const valor = Number((p.total || "0").replace("R$","").replace(",","."));
    if(p.pagamento?.toLowerCase() === "pix") totalPix += valor;
    else if(p.pagamento?.toLowerCase().includes("cart")) totalCartao += valor; // aceita Cartao ou Cart√£o
    else if(p.pagamento?.toLowerCase() === "dinheiro") totalDinheiro += valor;
  });

  const totalGeral = totalPix + totalCartao + totalDinheiro;
  document.getElementById('balancoValores').innerHTML = `
    <p><b>PIX:</b> R$ ${totalPix.toFixed(2).replace('.', ',')}</p>
    <p><b>Cart√£o de Cr√©dito:</b> R$ ${totalCartao.toFixed(2).replace('.', ',')}</p>
    <p><b>Dinheiro:</b> R$ ${totalDinheiro.toFixed(2).replace('.', ',')}</p>
    <hr>
    <p style="color:var(--accent); font-size:22px"><b>Total Geral:</b> R$ ${totalGeral.toFixed(2).replace('.', ',')}</p>
  `;
});



    window.deletarDoc = async (id) => {
      const res = await Swal.fire({ title: 'Excluir?', icon: 'warning', showCancelButton: true, background: '#161616', color: '#fff' });
      if(res.isConfirmed) await deleteDoc(doc(db, "pedidos", id));
    };

    window.fecharModal = () => document.getElementById('modalMesa').style.display = 'none';

    // apagar tudo
    window.apagarTodosPedidos = async () => {
  const res = await Swal.fire({
    title: 'Apagar todos os pedidos?',
    text: 'Essa a√ß√£o n√£o pode ser desfeita!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ff4d4d',
    background: '#161616',
    color: '#fff'
  });

  if(res.isConfirmed) {
    const snapshot = await getDocs(collection(db, "pedidos"));
    const promises = snapshot.docs.map(d => deleteDoc(doc(db, "pedidos", d.id)));
    await Promise.all(promises);

    Swal.fire({
      title: 'Todos os pedidos foram apagados!',
      icon: 'success',
      background: '#161616',
      color: '#fff',
      timer: 1500,
      showConfirmButton: false
    });
  }
};
// Fun√ß√£o para abrir/fechar o menu administrativo
window.toggleAdminMenu = () => {
  const menu = document.getElementById('adminMenu');
  const isVisible = menu.style.display === 'flex';
  menu.style.display = isVisible ? 'none' : 'flex';
};

// Fechar o menu se clicar fora dele
document.addEventListener('click', (e) => {
  const menu = document.getElementById('adminMenu');
  const btn = e.target.closest('button');
  if (menu.style.display === 'flex' && !menu.contains(e.target) && (!btn || btn.innerText !== '‚öôÔ∏è')) {
    menu.style.display = 'none';
  }
});

// Ajuste na fun√ß√£o Ativar Som para n√£o quebrar o layout do menu
const btnSom = document.getElementById('ativarSom');
btnSom.onclick = function() { 
  somAtivado = true; 
  this.innerHTML = "üîî SISTEMA ONLINE";
  this.style.background = "#00e676"; // Muda para verde quando ativo
  setTimeout(() => { toggleAdminMenu(); }, 500); // Fecha o menu ap√≥s ativar
};

  </script>
</body>
</html>