<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Pedidos</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; }
    h1 { text-align: center; }
    .pedido {
      background: white;
      padding: 15px;
      margin: 10px auto;
      border-radius: 8px;
      max-width: 500px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: border 0.3s ease;
    }
    .pedido.entrega-saiu {
      border: 10px solid green;
    }
    .itens { margin-top: 10px; }
    .item { border-bottom: 1px solid #ddd; padding: 5px 0; }
    .botoes { 
      margin-top: 10px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
    }
    button {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .excluir { background: #f44336; color: white; }
    .whatsapp { background: #25D366; color: white; }
    .whatsapp-entrega { background: #2196F3; color: white; margin-left: auto; }
    .excluir-tudo { background: #000; color: white; display: block; margin: 10px auto; }
    .status { font-weight: bold; padding: 3px 6px; border-radius: 4px; }
    .confirmado { background: green; color: white; }
    .em-entrega { background: blue; color: white; }
    #ativarSom { background: orange; color: white; display: block; margin: 10px auto; }
  </style>
</head>
<body>
  <h1>📦 Painel de Pedidos</h1>
  <button id="ativarSom">🔊 Ativar Som</button>
  <button id="btnExcluirTudo" class="excluir-tudo">🗑️ Excluir Todos os Pedidos</button>
  <div id="lista-pedidos"></div>

  <!-- Áudio do alerta -->
  <audio id="bip" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
  </audio>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { 
    getFirestore, collection, onSnapshot, orderBy, query, limit,
    deleteDoc, doc, getDocs
  } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "meusiteaki2025.firebaseapp.com",
    projectId: "meusiteaki2025",
    storageBucket: "meusiteaki2025.firebasestorage.app",
    messagingSenderId: "1059720978927",
    appId: "1:1059720978927:web:c4e5fde24aa95672d0161a",
    measurementId: "G-KD8EDDRLWZ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const listaPedidos = document.getElementById('lista-pedidos');
  const btnExcluirTudo = document.getElementById('btnExcluirTudo');
  const bip = document.getElementById('bip');
  const btnAtivarSom = document.getElementById('ativarSom');

  let somAtivado = false;

  // Ativar som manualmente
  btnAtivarSom.addEventListener('click', () => {
    bip.play().then(() => {
      bip.pause();
      bip.currentTime = 0;
      somAtivado = true;
      alert("Som ativado! Agora os alertas vão funcionar.");
      btnAtivarSom.style.display = "none"; // esconde botão depois de ativar
    });
  });

  // Função para tocar alerta 2x
  function tocarAlerta() {
    if (!somAtivado) return; // só toca se o usuário ativou
    bip.volume = 1.0;
    bip.currentTime = 0;
    bip.play();
    setTimeout(() => {
      bip.currentTime = 0;
      bip.play();
    }, 1000);
  }

  const q = query(collection(db, "pedidos"), orderBy("timestamp", "desc"), limit(1));

  onSnapshot(q, snapshot => {
    if (snapshot.empty) {
      listaPedidos.innerHTML = "<p style='text-align: center;'>Nenhum pedido no momento.</p>";
      return;
    }

    listaPedidos.innerHTML = "";

    snapshot.forEach(docSnap => {
      const pedido = docSnap.data();

      const div = document.createElement('div');
      div.classList.add('pedido');

      let statusHtml = "";
      if (pedido.status === "confirmado") {
        statusHtml = `<span class="status confirmado">✅ Confirmado</span>`;
      } else if (pedido.status === "entrega") {
        statusHtml = `<span class="status em-entrega">🚚 Em Entrega</span>`;
      }

      div.innerHTML = `
        ${statusHtml}
        <p><strong>👤 Cliente:</strong> ${pedido.cliente}</p>
        <p><strong>📞 Tel:</strong> ${pedido.telefone}</p>
        <p><strong>🏠 Endereço:</strong> ${pedido.endereco}</p>
        <p><strong>💳 Pagamento:</strong> ${pedido.pagamento}</p>
        <div class="itens">
          <strong>🍔 Itens:</strong>
          ${pedido.itens.map(item => `<div class="item">${item.quantity}x ${item.name}</div>`).join('')}
        </div>
        <p><strong>🚚 Entrega:</strong> R$ ${pedido.taxaEntrega?.toFixed(2).replace('.', ',') || "0,00"}</p>
        <p><strong>💰 Total:</strong> R$ ${pedido.total.replace('.', ',')}</p>
        ${pedido.observacao ? `<p><strong>📝 Obs:</strong> ${pedido.observacao}</p>` : ""}
        <div class="botoes">
          <button class="excluir">🗑️ Excluir</button>
          <button class="whatsapp">💬 WhatsApp</button>
          <button class="whatsapp-entrega">📦 Saiu p/ Entrega</button>
        </div>
      `;

      // Botão excluir
      div.querySelector('.excluir').addEventListener('click', async () => {
        if (confirm("Tem certeza que deseja excluir este pedido?")) {
          await deleteDoc(doc(db, "pedidos", docSnap.id));
        }
      });

      // Botão WhatsApp (mensagem inicial)
      div.querySelector('.whatsapp').addEventListener('click', () => {
        const numero = pedido.telefone.replace(/\D/g, '');
        const mensagem = "Boa noite, seu pedido já está na fila de preparo, por favor aguarde!";
        const url = `https://wa.me/55${numero}?text=${encodeURIComponent(mensagem)}`;
        window.open(url, '_blank');
      });

      // Botão WhatsApp Entrega
      div.querySelector('.whatsapp-entrega').addEventListener('click', () => {
        const numero = pedido.telefone.replace(/\D/g, '');
        const mensagem = "Olá! Seu pedido já saiu para entrega 🚚. Muito obrigado e volte sempre. *Jhonny Bagdá agradece!*";
        const url = `https://wa.me/55${numero}?text=${encodeURIComponent(mensagem)}`;
        window.open(url, '_blank');
        div.classList.add('entrega-saiu');
      });

      listaPedidos.appendChild(div);
    });

    // Agora toca alerta sempre que houver pedido novo
    snapshot.docChanges().forEach(change => {
      if (change.type === 'added') {
        tocarAlerta();
      }
    });
  });

  btnExcluirTudo.addEventListener('click', async () => {
    const pedidos = await getDocs(collection(db, "pedidos"));
    const promises = pedidos.docs.map(doc => deleteDoc(doc.ref));
    await Promise.all(promises);
  });
  </script>
</body>
</html>
